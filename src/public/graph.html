<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Production Graph</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.4/cytoscape.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; max-width: 1100px; margin: 0 auto; padding: 1rem; background: #f5f5f5; }
    h1 { margin-bottom: 1rem; }
    section { background: #fff; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #ddd; }
    label { font-weight: 600; margin-right: 0.5rem; }
    select { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 4px 12px; border: 1px solid #999; border-radius: 4px; background: #fff; cursor: pointer; }
    button:hover { background: #eee; }
    button.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
    button.primary:hover { background: #1d4ed8; }
    .row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    #graph { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 4px; }
  </style>
</head>
<body>
  <nav style="margin-bottom:1rem"><a href="/">Editor</a> | <a href="/calculator.html">Calculator</a> | <strong>Graph</strong></nav>
  <h1>Production Graph</h1>

  <section>
    <div class="row">
      <label>Book:</label>
      <select id="bookSelect"><option value="">-- select --</option></select>
      <button class="primary" onclick="loadGraph()">Load</button>
    </div>
    <div class="row">
      <label>Layout:</label>
      <select id="layoutSelect" onchange="relayout()">
        <option value="cose">Physics</option>
        <option value="breadthfirst">Hierarchical</option>
      </select>
    </div>
  </section>

  <section>
    <div id="graph"></div>
  </section>

  <script>
    let cy = null;

    // --- localStorage helpers ---
    function getLocalBooks() {
      try { return JSON.parse(localStorage.getItem('books') || '{}'); } catch { return {}; }
    }

    function initGraph() {
      cy = cytoscape({
        container: document.getElementById('graph'),
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'text-wrap': 'wrap',
              'text-max-width': '140px',
              'text-valign': 'center',
              'text-halign': 'center',
              'font-size': '11px',
              'background-color': 'data(color)',
              'border-width': 2,
              'border-color': '#666',
              'width': 'label',
              'height': 'label',
              'padding': '12px',
              'shape': 'round-rectangle',
            },
          },
          {
            selector: 'edge',
            style: {
              'label': 'data(label)',
              'font-size': '10px',
              'text-wrap': 'wrap',
              'text-max-width': '300px',
              'text-overflow-wrap': 'anywhere',
              'text-background-color': '#fff',
              'text-background-opacity': 1,
              'text-background-padding': '2px',
              'width': 2,
              'line-color': '#999',
              'target-arrow-color': '#999',
              'target-arrow-shape': 'triangle',
              'curve-style': 'bezier',
              'arrow-scale': 1.2,
            },
          },
        ],
        layout: { name: 'grid' },
        elements: [],
      });
    }

    function renderGraph(graph) {
      if (!cy) initGraph();
      cy.elements().remove();

      const elements = [];

      for (const recipe of graph.nodes) {
        const isSource = recipe.inputs.length === 0;
        const fmtStack = s => s.quantity === 1 ? s.product.name : `(${s.quantity}x ${s.product.name})`;
        const inputs = recipe.inputs.map(fmtStack).join(' + ');
        const outputs = recipe.outputs.map(fmtStack).join(' + ');
        const label = isSource ? outputs + ' (source)' : inputs + ' â†’ ' + outputs;
        elements.push({
          group: 'nodes',
          data: {
            id: recipe.name,
            label,
            color: isSource ? '#d1fae5' : '#dbeafe',
          },
        });
      }

      for (let i = 0; i < graph.edges.length; i++) {
        const edge = graph.edges[i];
        const [a, b] = edge.ratio;
        elements.push({
          group: 'edges',
          data: {
            id: `e${i}`,
            source: edge.from.name,
            target: edge.to.name,
            label: `${edge.product.name}\n${a}:${b}`,
          },
        });
      }

      cy.add(elements);
      relayout();
    }

    function getLayoutOptions() {
      const name = document.getElementById('layoutSelect').value;
      if (name === 'breadthfirst') {
        return {
          name: 'breadthfirst',
          directed: true,
          roots: cy.nodes().filter(n => n.indegree() === 0),
          spacingFactor: 1.2,
          animate: true,
          animationDuration: 400,
          nodeDimensionsIncludeLabels: true,
        };
      }
      return {
        name: 'cose',
        animate: true,
        animationDuration: 400,
        nodeRepulsion: () => 8000,
        idealEdgeLength: () => 120,
        gravity: 0.3,
        numIter: 500,
        nodeDimensionsIncludeLabels: true,
      };
    }

    function relayout() {
      if (!cy || cy.nodes().length === 0) return;
      cy.layout(getLayoutOptions()).run();
    }

    async function refreshBookList() {
      let serverNames = [];
      try {
        const res = await fetch('/api/books');
        serverNames = await res.json();
      } catch {}
      const localBooks = getLocalBooks();

      const sel = document.getElementById('bookSelect');
      sel.innerHTML = '<option value="">-- select --</option>';
      for (const n of serverNames) {
        const opt = document.createElement('option');
        opt.value = `preset:${n}`;
        opt.textContent = `${n} (preset)`;
        sel.appendChild(opt);
      }
      for (const n of Object.keys(localBooks)) {
        const opt = document.createElement('option');
        opt.value = `local:${n}`;
        opt.textContent = n;
        sel.appendChild(opt);
      }
    }

    function parseSelection() {
      const val = document.getElementById('bookSelect').value;
      if (!val) return null;
      const [source, ...rest] = val.split(':');
      return { source, name: rest.join(':') };
    }

    async function loadGraph() {
      const sel = parseSelection();
      if (!sel) return;

      let book;
      if (sel.source === 'preset') {
        // Use GET endpoint for presets
        const res = await fetch(`/api/graph/${encodeURIComponent(sel.name)}`);
        if (!res.ok) return;
        const graph = await res.json();
        renderGraph(graph);
        return;
      } else {
        book = getLocalBooks()[sel.name];
        if (!book) return;
      }

      // POST book data for local books
      const res = await fetch('/api/graph', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(book),
      });
      if (!res.ok) return;
      const graph = await res.json();
      renderGraph(graph);
    }

    refreshBookList();
    initGraph();
  </script>
</body>
</html>
